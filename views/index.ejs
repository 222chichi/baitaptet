<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Todo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">

<div class="d-flex justify-content-between mb-3">
<h4>Xin chào <%= currentUser.fullName %> (<%= currentUser.role %>)</h4>
<a href="/logout" class="btn btn-danger btn-sm">Logout</a>
</div>

<div class="card p-4 shadow rounded-4">

<form action="/tasks" method="POST" class="mb-3">
<input type="text" name="title" class="form-control mb-2" placeholder="Nhập công việc..." required>

<% if(currentUser.role === "admin") { %>
<select name="assignedUsers" multiple class="form-control mb-2">
<% users.forEach(u => { %>
<option value="<%= u._id %>"><%= u.fullName %></option>
<% }) %>
</select>
<% } %>

<button class="btn btn-primary">Thêm</button>
</form>

<ul class="list-group">

<% tasks.forEach(task => { %>
<li class="list-group-item d-flex justify-content-between align-items-center">

<div>
<strong><%= task.title %></strong><br>
<small>Assigned:
<% task.assignedUsers.forEach(u => { %>
<%= u.fullName %>,
<% }) %>
</small>

<% if(task.isDone) { %>
<div class="text-success">✔ Hoàn thành</div>
<% } %>
</div>

<div class="d-flex gap-2">

<% if(!task.completedBy.some(u => u._id.toString() === currentUser._id) && !task.isDone) { %>
<form action="/complete" method="POST">
<input type="hidden" name="taskId" value="<%= task._id %>">
<button class="btn btn-success btn-sm">Hoàn thành</button>
</form>
<% } %>

<form action="/delete" method="POST">
<input type="hidden" name="taskId" value="<%= task._id %>">
<button class="btn btn-danger btn-sm">Xóa</button>
</form>

</div>

</li>
<% }) %>

</ul>

<div class="mt-4">
<div class="progress">
<div class="progress-bar bg-success" style="width:<%= percent %>%"></div>
</div>
<p class="mt-2">Tiến độ: <%= percent %>%</p>
</div>

</div>
</div>
</body>
</html>
